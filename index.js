var _0x7728=["\x63\x6F\x6E\x66\x69\x67","\x64\x6F\x74\x65\x6E\x76","\x6D\x6F\x6D\x65\x6E\x74","\x6D\x6F\x6E\x67\x6F\x6F\x73\x65","\x6D\x73\x73\x71\x6C","\x2E\x2F\x6D\x6F\x64\x65\x6C\x73\x2F\x72\x61\x77\x64\x61\x74\x61\x2E\x6D\x6F\x64\x65\x6C","\x2E\x2F\x6D\x6F\x64\x65\x6C\x73\x2F\x63\x61\x6C\x63\x64\x61\x74\x61\x2E\x6D\x6F\x64\x65\x6C","\x65\x6E\x76","\x63\x6F\x6E\x6E\x65\x63\x74","\x75\x73\x65\x46\x69\x6E\x64\x41\x6E\x64\x4D\x6F\x64\x69\x66\x79","\x73\x65\x74","\x53\x51\x4C\x5F\x53\x45\x52\x56\x45\x52\x5F\x50\x41\x53\x53\x57\x4F\x52\x44","\x53\x51\x4C\x5F\x53\x45\x52\x56\x45\x52\x5F\x44\x41\x54\x41\x42\x41\x53\x45","\x53\x51\x4C\x5F\x53\x45\x52\x56\x45\x52\x5F\x55\x53\x45\x52\x4E\x41\x4D\x45","\x53\x51\x4C\x5F\x53\x45\x52\x56\x45\x52\x5F\x53\x45\x52\x56\x45\x52","\x74\x65\x64\x69\x6F\x75\x73","\x46\x4C\x45\x58\x59\x5F\x4E\x61\x6D\x65\x73\x70\x61\x63\x65","\x76\x61\x6C\x75\x65","\x64\x61\x74\x61","\x74\x69\x65\x72\x31","\x74\x69\x65\x72\x32","\x73\x69\x74\x65\x5F\x69\x64","\x73\x69\x74\x65\x5F\x6E\x61\x6D\x65","\x73\x74\x72\x69\x6E\x67\x69\x66\x79","\x45\x72\x72\x6F\x72\x20\x73\x61\x76\x65\x20\x64\x61\x74\x61\x20\x74\x6F\x20\x4C\x6F\x63\x61\x6C\x20\x64\x61\x74\x61","\x6C\x6F\x67","\x69\x6E\x73\x65\x72\x74\x4D\x61\x6E\x79","\x6D\x69\x6E\x75\x74\x65\x73","\x73\x75\x62\x74\x72\x61\x63\x74","\x66\x69\x6E\x64","\x63\x6F\x75\x6E\x74\x44\x6F\x63\x75\x6D\x65\x6E\x74\x73","\x69\x6E\x66\x6F\x72\x6D\x61\x74\x69\x6F\x6E","\x66\x6F\x72\x45\x61\x63\x68","\x63\x72\x65\x61\x74\x65\x64\x5F\x61\x74","\x61\x76\x72\x46\x6C\x6F\x77","\x61\x76\x72\x5F\x66\x6C\x6F\x77","\x64\x61\x79\x73","\x64\x65\x6C\x65\x74\x65\x4D\x61\x6E\x79","\x44\x65\x6C\x65\x74\x65\x64\x20\x64\x61\x74\x61\x20\x62\x65\x66\x6F\x72\x65\x20","\x54\x6F\x74\x61\x6C\x20\x72\x65\x63\x6F\x72\x64\x20\x64\x65\x6C\x65\x74\x65\x64\x20\x3D\x20","\x64\x65\x6C\x65\x74\x65\x64\x43\x6F\x75\x6E\x74","\x46\x4C\x45\x58\x59\x5F\x54\x61\x67\x6E\x61\x6D\x65\x31","\x46\x4C\x45\x58\x59\x5F\x54\x61\x67\x6E\x61\x6D\x65\x32","\x46\x4C\x45\x58\x59\x5F\x54\x61\x67\x6E\x61\x6D\x65\x33","\x46\x4C\x45\x58\x59\x5F\x54\x61\x67\x6E\x61\x6D\x65\x34","\x66\x6F\x72\x6D\x61\x74","\x6C\x6F\x63\x61\x6C","\x70\x75\x73\x68","\x69\x70","\x70\x6F\x72\x74","\x4F\x50\x43\x5F\x53\x45\x52\x56\x45\x52\x5F\x55\x53\x45\x52\x4E\x41\x4D\x45","\x4F\x50\x43\x5F\x53\x45\x52\x56\x45\x52\x5F\x50\x41\x53\x53\x57\x4F\x52\x44","\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A\x2A","\x6E\x6F\x64\x65\x2D\x6F\x70\x63\x75\x61","\x61\x73\x79\x6E\x63","\x6F\x70\x63\x2E\x74\x63\x70\x3A\x2F\x2F","\x3A","\x43\x61\x6E\x6E\x6F\x74\x20\x63\x6F\x6E\x6E\x65\x63\x74\x20\x74\x6F\x20\x65\x6E\x64\x70\x6F\x69\x6E\x74\x20\x3A","\x43\x6F\x6E\x6E\x65\x63\x74\x65\x64\x20\x74\x6F\x20\x46\x6C\x65\x78\x79\x21","\x75\x73\x65\x72\x6E\x61\x6D\x65","\x70\x61\x73\x73\x77\x6F\x72\x64","\x63\x72\x65\x61\x74\x65\x53\x65\x73\x73\x69\x6F\x6E","\x74\x65\x72\x6D\x69\x6E\x61\x74\x65\x64","\x6F\x6E","\x6B\x65\x65\x70\x61\x6C\x69\x76\x65","\x73\x74\x61\x72\x74\x65\x64","\x6E\x73\x3D","\x3B\x73\x3D","\x6E\x61\x6D\x65","\x72\x65\x73\x6F\x6C\x76\x65\x4E\x6F\x64\x65\x49\x64","\x6D\x6F\x6E\x69\x74\x6F\x72","\x63\x68\x61\x6E\x67\x65\x64","\x22\x54\x61\x67\x4E\x61\x6D\x65\x22","\x22","\x2C","\x22\x56\x61\x6C\x75\x65\x22","\x66\x69\x6E\x64\x49\x6E\x64\x65\x78","\x74\x6F\x46\x69\x78\x65\x64","\x74\x69\x6D\x65","\x20\x63\x6C\x6F\x73\x69\x6E\x67\x20\x73\x65\x73\x73\x69\x6F\x6E","\x20\x73\x65\x73\x73\x69\x6F\x6E\x20\x63\x6C\x6F\x73\x65\x64","\x63\x6C\x6F\x73\x65","\x20\x66\x61\x69\x6C\x75\x72\x65\x20","\x64\x6F\x6E\x65\x21","\x64\x69\x73\x63\x6F\x6E\x6E\x65\x63\x74","\x73\x65\x72\x69\x65\x73","\x69\x6E\x70\x75\x74","\x49\x4E\x53\x45\x52\x54\x20\x49\x4E\x54\x4F\x20\x44\x61\x74\x61\x4C\x6F\x67\x67\x65\x72\x31\x20\x28\x73\x69\x74\x65\x5F\x69\x64\x2C\x20\x73\x69\x74\x65\x5F\x6E\x61\x6D\x65\x2C\x20\x69\x6E\x66\x6F\x72\x6D\x61\x74\x69\x6F\x6E\x2C\x20\x63\x72\x65\x61\x74\x65\x64\x5F\x61\x74\x2C\x20\x74\x69\x65\x72\x31\x2C\x20\x74\x69\x65\x72\x32\x29\x20\x56\x41\x4C\x55\x45\x53\x20\x28\x40\x73\x69\x74\x65\x5F\x69\x64\x2C\x40\x73\x69\x74\x65\x5F\x6E\x61\x6D\x65\x2C\x20\x40\x69\x6E\x66\x6F\x72\x6D\x61\x74\x69\x6F\x6E\x2C\x20\x40\x63\x72\x65\x61\x74\x65\x64\x5F\x61\x74\x2C\x20\x40\x74\x69\x65\x72\x31\x2C\x20\x40\x74\x69\x65\x72\x32\x29","\x71\x75\x65\x72\x79","\x49\x4E\x53\x45\x52\x54\x20\x49\x4E\x54\x4F\x20\x44\x61\x74\x61\x4C\x6F\x67\x67\x65\x72\x32\x20\x28\x73\x69\x74\x65\x5F\x69\x64\x2C\x20\x73\x69\x74\x65\x5F\x6E\x61\x6D\x65\x2C\x20\x61\x76\x72\x66\x6C\x6F\x77\x2C\x20\x74\x69\x65\x72\x31\x2C\x20\x74\x69\x65\x72\x32\x2C\x20\x63\x72\x65\x61\x74\x65\x64\x5F\x61\x74\x29\x20\x56\x41\x4C\x55\x45\x53\x20\x28\x40\x73\x69\x74\x65\x5F\x69\x64\x2C\x40\x73\x69\x74\x65\x5F\x6E\x61\x6D\x65\x2C\x20\x40\x61\x76\x72\x46\x6C\x6F\x77\x2C\x20\x40\x74\x69\x65\x72\x31\x2C\x20\x40\x74\x69\x65\x72\x32\x2C\x20\x40\x63\x72\x65\x61\x74\x65\x64\x5F\x61\x74\x29","\x62\x65\x66\x6F\x72\x65\x64\x61\x79","\x44\x45\x4C\x45\x54\x45\x20\x46\x52\x4F\x4D\x20\x44\x61\x74\x61\x4C\x6F\x67\x67\x65\x72\x31\x20\x57\x48\x45\x52\x45\x20\x63\x72\x65\x61\x74\x65\x64\x5F\x61\x74\x20\x3C\x20\x40\x62\x65\x66\x6F\x72\x65\x64\x61\x79"];require(_0x7728[1])[_0x7728[0]]();var moment=require(_0x7728[2]);var mongoose=require(_0x7728[3]);var sql=require(_0x7728[4]);var RawData=require(_0x7728[5]);var CalcData=require(_0x7728[6]);mongoose[_0x7728[8]](process[_0x7728[7]].MONGO_URL,{useNewUrlParser:true,useUnifiedTopology:true});mongoose[_0x7728[10]](_0x7728[9],false);const sqlConfig={password:process[_0x7728[7]][_0x7728[11]],database:process[_0x7728[7]][_0x7728[12]],stream:false,options:{enableArithAbort:true,encrypt:true},port:parseInt(process[_0x7728[7]].SQL_SERVER_PORT),user:process[_0x7728[7]][_0x7728[13]],server:process[_0x7728[7]][_0x7728[14]],driver:_0x7728[15]};let TIER_2_BENCHMARK=parseFloat(process[_0x7728[7]].TIER_2_BENCHMARK);let TIME_INTERVAL_GETDATA=parseInt(process[_0x7728[7]].TIME_INTERVAL_GETDATA)* 1000;let TIME_INTERVAL_CALCDATA=parseInt(process[_0x7728[7]].TIME_INTERVAL_CALCDATA)* 1000;let TIME_INTERVAL_REMOVE_DATA=parseInt(process[_0x7728[7]].TIME_INTERVAL_REMOVE_DATA)* 86400000;let flexy_ns=process[_0x7728[7]][_0x7728[16]];var opc_server=[];var opc_server_avr=[];async function run(){ await readFirstConfig(); await readOPCUA(); await setTimeout(function(){},5000); await setInterval(async function(){let _0x825exf=opc_server[0][_0x7728[18]][3][_0x7728[17]];let _0x825ex10=opc_server[0][_0x7728[19]];let _0x825ex11=opc_server[0][_0x7728[20]];let _0x825ex12,_0x825ex13;if(_0x825exf> TIER_2_BENCHMARK){_0x825ex12= TIER_2_BENCHMARK/ 60+ _0x825ex10;_0x825ex13= (_0x825exf- TIER_2_BENCHMARK)/ 60+ _0x825ex11}else {_0x825ex12= _0x825exf/ 60+ _0x825ex10;_0x825ex13= 0+ _0x825ex11};opc_server[0][_0x7728[19]]= _0x825ex12;opc_server[0][_0x7728[20]]= _0x825ex13;insert_data(opc_server[0][_0x7728[21]],opc_server[0][_0x7728[22]],JSON[_0x7728[23]](opc_server[0][_0x7728[18]]),_0x825ex12,_0x825ex13);let _0x825ex14={site_id:opc_server[0][_0x7728[21]],site_name:opc_server[0][_0x7728[22]],information:opc_server[0][_0x7728[18]],tier1:opc_server[0][_0x7728[19]],tier2:opc_server[0][_0x7728[20]],created_at: new Date()};RawData[_0x7728[26]](_0x825ex14,function(_0x825ex15,_0x825ex16){if(_0x825ex15){console[_0x7728[25]](_0x7728[24])}})},TIME_INTERVAL_GETDATA); await setInterval(async function(){let _0x825ex17=moment()[_0x7728[28]](15,_0x7728[27]);let _0x825ex18=moment();let _0x825ex19={created_at:{$gte:_0x825ex17,$lte:_0x825ex18},tier1:{$gt:0}};let _0x825ex1a= await RawData[_0x7728[29]](_0x825ex19);let _0x825ex1b= await RawData[_0x7728[30]](_0x825ex19);let _0x825ex1c=0;_0x825ex1a[_0x7728[32]](function(_0x825ex1d){_0x825ex1c= _0x825ex1c+ parseFloat(_0x825ex1d[_0x7728[31]][3][_0x7728[17]])});let _0x825ex1e=0;if(_0x825ex1b> 0){_0x825ex1e= _0x825ex1c/ _0x825ex1b};let _0x825ex1f=opc_server_avr[_0x7728[19]];let _0x825ex20=opc_server_avr[_0x7728[20]];let _0x825ex21,_0x825ex22;if(_0x825ex1e> TIER_2_BENCHMARK){_0x825ex21= TIER_2_BENCHMARK/ 60+ _0x825ex1f;_0x825ex22= (_0x825ex1e- TIER_2_BENCHMARK)/ 60+ _0x825ex20}else {_0x825ex21= _0x825ex1e/ 60+ _0x825ex1f;_0x825ex22= 0+ _0x825ex20};opc_server_avr[_0x7728[19]]= _0x825ex21;opc_server_avr[_0x7728[20]]= _0x825ex22;opc_server_avr[_0x7728[33]]=  new Date();opc_server_avr[_0x7728[34]]= _0x825ex1e;let _0x825ex23=opc_server_avr;_0x825ex23[_0x7728[35]]= opc_server_avr[_0x7728[34]];CalcData[_0x7728[26]](_0x825ex23,function(_0x825ex15,_0x825ex16){if(_0x825ex15){console[_0x7728[25]](_0x7728[24])}});saveAvrDataToDatabase(opc_server[0][_0x7728[21]],opc_server[0][_0x7728[22]],opc_server_avr[_0x7728[34]],opc_server_avr[_0x7728[19]],opc_server_avr[_0x7728[20]])},TIME_INTERVAL_CALCDATA); await setInterval(async function(){let _0x825ex24=moment()[_0x7728[28]](10,_0x7728[36]);const _0x825ex25= await RawData[_0x7728[37]]({created_at:{$lte:_0x825ex24}});console[_0x7728[25]](_0x7728[38],_0x825ex24,_0x7728[39],_0x825ex25[_0x7728[40]]);deleteDataAfter10days()},TIME_INTERVAL_REMOVE_DATA)}run();async function readFirstConfig(){let _0x825ex27=[];let _0x825ex28=[process[_0x7728[7]][_0x7728[41]],process[_0x7728[7]][_0x7728[42]],process[_0x7728[7]][_0x7728[43]],process[_0x7728[7]][_0x7728[44]]];for(const _0x825ex29 of _0x825ex28){_0x825ex27[_0x7728[47]]({name:_0x825ex29,value:0,time:moment()[_0x7728[46]]()[_0x7728[45]]()})};let _0x825ex2a={id:1,site_id:process[_0x7728[7]][_0x7728[21]],site_name:process[_0x7728[7]][_0x7728[22]],ip:process[_0x7728[7]][_0x7728[48]],port:parseInt(process[_0x7728[7]][_0x7728[49]]),username:process[_0x7728[7]][_0x7728[50]],password:process[_0x7728[7]][_0x7728[51]],data:_0x825ex27,tier1:0,tier2:0};opc_server[_0x7728[47]](_0x825ex2a);console[_0x7728[25]](_0x7728[52]);console[_0x7728[25]](_0x825ex28,opc_server);opc_server_avr= {avrFlow:0,tier1:0,tier2:0};return}async function readOPCUA(){var _0x825ex2c=require(_0x7728[53]),_0x825ex2d=require(_0x7728[54]),_0x825ex2e= new _0x825ex2c.OPCUAClient(),_0x825ex2f= new Array(),_0x825ex30=0,_0x825ex31= new Array(),_0x825ex32=null;const _0x825ex33=_0x7728[55]+ opc_server[0][_0x7728[48]]+ _0x7728[56]+ opc_server[0][_0x7728[49]];_0x825ex2d[_0x7728[85]]([function(_0x825ex34){_0x825ex2e[_0x7728[8]](_0x825ex33,function(_0x825ex35){if(_0x825ex35){console[_0x7728[25]](_0x7728[57],_0x825ex33)}else {console[_0x7728[25]](_0x7728[58])};_0x825ex34(_0x825ex35)})},function(_0x825ex34){_0x825ex2e[_0x7728[61]]({userName:opc_server[0][_0x7728[59]],password:opc_server[0][_0x7728[60]]},function(_0x825ex35,_0x825ex36){if(!_0x825ex35){_0x825ex32= _0x825ex36};_0x825ex34(_0x825ex35)})},function(_0x825ex34){the_subscription=  new _0x825ex2c.ClientSubscription(_0x825ex32,{requestedPublishingInterval:1000,requestedLifetimeCount:10,requestedMaxKeepAliveCount:2,maxNotificationsPerPublish:10,publishingEnabled:true,priority:10});the_subscription[_0x7728[63]](_0x7728[65],function(){})[_0x7728[63]](_0x7728[64],function(){})[_0x7728[63]](_0x7728[62],function(){_0x825ex34()});opc_server[0][_0x7728[18]][_0x7728[32]](function(_0x825ex37){var _0x825ex38=_0x7728[66]+ flexy_ns+ _0x7728[67]+ _0x825ex37[_0x7728[68]];_0x825ex31[_0x825ex30]= the_subscription[_0x7728[70]]({nodeId:_0x825ex2c[_0x7728[69]](_0x825ex38),attributeId:13},{samplingInterval:200,discardOldest:true,queueSize:10});_0x825ex31[_0x825ex30][_0x7728[63]](_0x7728[71],function(_0x825ex39){mesage= _0x7728[72]+ _0x7728[56]+ _0x7728[73]+ _0x825ex37+ _0x7728[73]+ _0x7728[74]+ _0x7728[75]+ _0x7728[56]+ _0x825ex39[_0x7728[17]][_0x7728[17]];var _0x825ex3a=opc_server[0][_0x7728[18]][_0x7728[76]](function(_0x825ex3b,_0x825ex3c){return _0x825ex3b[_0x7728[68]]=== _0x825ex37[_0x7728[68]]});opc_server[0][_0x7728[18]][_0x825ex3a][_0x7728[17]]= parseFloat(_0x825ex39[_0x7728[17]][_0x7728[17]][_0x7728[77]](2));opc_server[0][_0x7728[18]][_0x825ex3a][_0x7728[78]]=  new Date()});_0x825ex30= _0x825ex30+ 1})},function(_0x825ex34){console[_0x7728[25]](_0x7728[79]);_0x825ex32[_0x7728[81]](function(_0x825ex35){console[_0x7728[25]](_0x7728[80]);_0x825ex34()})}],function(_0x825ex35){if(_0x825ex35){console[_0x7728[25]](_0x7728[82],_0x825ex35)}else {console[_0x7728[25]](_0x7728[83])};_0x825ex2e[_0x7728[84]](function(){})})}function insert_data(_0x825ex3e,_0x825ex3f,_0x825ex40,_0x825ex12,_0x825ex13){sql[_0x7728[8]](sqlConfig,function(_0x825ex35){if(_0x825ex35){console[_0x7728[25]](_0x825ex35)}else {var _0x825ex41= new sql.Request();_0x825ex41[_0x7728[86]](_0x7728[21],sql.VarChar,_0x825ex3e);_0x825ex41[_0x7728[86]](_0x7728[22],sql.VarChar,_0x825ex3f);_0x825ex41[_0x7728[86]](_0x7728[31],sql.VarChar,_0x825ex40);_0x825ex41[_0x7728[86]](_0x7728[33],sql.DateTimeOffset, new Date());_0x825ex41[_0x7728[86]](_0x7728[19],sql.Decimal(10,2),parseFloat(_0x825ex12));_0x825ex41[_0x7728[86]](_0x7728[20],sql.Decimal(10,2),parseFloat(_0x825ex13));_0x825ex41[_0x7728[88]](_0x7728[87],function(_0x825ex35,_0x825ex42){if(_0x825ex35){console[_0x7728[25]](_0x825ex35)};sql[_0x7728[81]]()})}})}function saveAvrDataToDatabase(_0x825ex3e,_0x825ex3f,_0x825ex44,_0x825ex12,_0x825ex13){sql[_0x7728[8]](sqlConfig,function(_0x825ex35){if(_0x825ex35){console[_0x7728[25]](_0x825ex35)}else {var _0x825ex41= new sql.Request();_0x825ex41[_0x7728[86]](_0x7728[21],sql.VarChar,_0x825ex3e);_0x825ex41[_0x7728[86]](_0x7728[22],sql.VarChar,_0x825ex3f);_0x825ex41[_0x7728[86]](_0x7728[34],sql.Decimal(10,2),parseFloat(_0x825ex44));_0x825ex41[_0x7728[86]](_0x7728[19],sql.Decimal(10,2),parseFloat(_0x825ex12));_0x825ex41[_0x7728[86]](_0x7728[20],sql.Decimal(10,2),parseFloat(_0x825ex13));_0x825ex41[_0x7728[86]](_0x7728[33],sql.DateTimeOffset, new Date());_0x825ex41[_0x7728[88]](_0x7728[89],function(_0x825ex35,_0x825ex42){if(_0x825ex35){console[_0x7728[25]](_0x825ex35)};sql[_0x7728[81]]()})}})}function deleteDataAfter10days(){sql[_0x7728[8]](sqlConfig,function(_0x825ex35){if(_0x825ex35){console[_0x7728[25]](_0x825ex35)}else {var _0x825ex41= new sql.Request();let _0x825ex24=moment()[_0x7728[28]](10,_0x7728[36]);let _0x825ex46= new Date(_0x825ex24);_0x825ex41[_0x7728[86]](_0x7728[90],sql.DateTimeOffset,_0x825ex46);_0x825ex41[_0x7728[88]](_0x7728[91],function(_0x825ex35,_0x825ex42){if(_0x825ex35){console[_0x7728[25]](_0x825ex35)};sql[_0x7728[81]]()})}})}